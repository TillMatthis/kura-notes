<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Search your KURA Notes">
  <title>Search - KURA Notes</title>
  <link rel="stylesheet" href="/css/main.css">
</head>
<body>
  <!-- Header / Navigation -->
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a href="/" class="nav-brand">
          <span>üìö</span>
          <span>KURA Notes</span>
        </a>
        <ul class="nav-menu">
          <li><a href="/" class="nav-link">Home</a></li>
          <li><a href="/create.html" class="nav-link">Create Note</a></li>
          <li><a href="/upload.html" class="nav-link">Upload File</a></li>
          <li><a href="/search.html" class="nav-link">Search</a></li>
          <li><a href="/tags.html" class="nav-link">Tags</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="container">
      <h1>Search</h1>
      <p class="text-muted mb-4">
        Find your notes using natural language search
      </p>

      <!-- Search Form -->
      <div class="card mb-4">
        <form id="search-form">
          <div class="form-group mb-3">
            <label for="search-query" class="form-label">Search Query</label>
            <div style="display: flex; gap: var(--spacing-md);">
              <input
                type="text"
                id="search-query"
                name="query"
                class="form-input"
                placeholder="What are you looking for?"
                style="flex: 1;"
                autofocus
              >
              <button type="submit" class="btn btn-primary" id="search-btn">
                üîç Search
              </button>
            </div>
            <span class="form-help">
              Use natural language like "meeting notes from last week" or "design mockups"
            </span>
          </div>

          <!-- Filters (Collapsed by default) -->
          <details style="margin-top: var(--spacing-lg);" id="filters-details">
            <summary style="cursor: pointer; font-weight: 500; color: var(--text-primary); margin-bottom: var(--spacing-md);">
              Advanced Filters
            </summary>

            <div class="grid grid-cols-3" style="gap: var(--spacing-md);">
              <!-- Content Type Filter -->
              <div class="form-group">
                <label class="form-label">Content Type</label>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
                  <label style="display: flex; align-items: center; gap: var(--spacing-sm); font-weight: normal;">
                    <input type="checkbox" name="contentType" value="text" checked>
                    <span>üìù Text</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: var(--spacing-sm); font-weight: normal;">
                    <input type="checkbox" name="contentType" value="image" checked>
                    <span>üñºÔ∏è Images</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: var(--spacing-sm); font-weight: normal;">
                    <input type="checkbox" name="contentType" value="pdf" checked>
                    <span>üìÑ PDFs</span>
                  </label>
                </div>
              </div>

              <!-- Date Range Filter -->
              <div class="form-group">
                <label for="date-from" class="form-label">Date From</label>
                <input
                  type="date"
                  id="date-from"
                  name="dateFrom"
                  class="form-input"
                >
              </div>

              <div class="form-group">
                <label for="date-to" class="form-label">Date To</label>
                <input
                  type="date"
                  id="date-to"
                  name="dateTo"
                  class="form-input"
                >
              </div>

              <!-- Tags Filter -->
              <div class="form-group" style="grid-column: 1 / -1;">
                <label for="filter-tags" class="form-label">Tags</label>
                <input
                  type="text"
                  id="filter-tags"
                  name="tags"
                  class="form-input"
                  placeholder="work, personal (comma-separated)"
                >
                <span class="form-help">Click tags in search results to filter, or type here</span>
                <!-- Active tag filters display -->
                <div id="active-tag-filters" style="margin-top: var(--spacing-sm); display: none; gap: var(--spacing-xs); flex-wrap: wrap;">
                </div>
              </div>

              <!-- Clear Filters Button -->
              <div class="form-group" style="grid-column: 1 / -1; margin-top: var(--spacing-md);">
                <button type="button" class="btn btn-secondary" id="clear-filters-btn">
                  Clear Filters
                </button>
              </div>
            </div>
          </details>
        </form>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="hidden">
        <div class="card">
          <div style="padding: var(--spacing-2xl); text-align: center;">
            <div class="loading-spinner" style="margin: 0 auto var(--spacing-lg);"></div>
            <p class="text-muted">Searching...</p>
          </div>
        </div>
      </div>

      <!-- Search Results -->
      <div id="search-results" class="hidden">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Search Results</h2>
            <p class="card-description" id="results-count"></p>
          </div>

          <!-- Bulk Actions Toolbar -->
          <div id="bulk-actions-toolbar-search" class="bulk-actions-toolbar" style="display: none;">
            <div style="display: flex; align-items: center; gap: var(--spacing-md);">
              <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer;">
                <input type="checkbox" id="select-all-checkbox-search" style="cursor: pointer;">
                <span id="selection-count-search" style="font-weight: 500;">0 selected</span>
              </label>
            </div>
            <div style="display: flex; gap: var(--spacing-sm);">
              <button type="button" class="btn btn-danger btn-sm" id="bulk-delete-btn-search" onclick="bulkDeleteSearch()">
                üóëÔ∏è Delete Selected
              </button>
              <button type="button" class="btn btn-secondary btn-sm" id="bulk-tag-btn-search" onclick="bulkAddTagsSearch()">
                üè∑Ô∏è Add Tags
              </button>
            </div>
          </div>

          <div id="results-container"></div>
        </div>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="card text-center">
        <div style="padding: var(--spacing-2xl);">
          <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üîç</div>
          <h3>No search yet</h3>
          <p class="text-muted">
            Enter a search query above to find your notes, images, and documents.
          </p>
        </div>
      </div>

      <!-- No Results State -->
      <div id="no-results" class="card text-center hidden">
        <div style="padding: var(--spacing-2xl);">
          <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">ü§∑</div>
          <h3>No results found</h3>
          <p class="text-muted">
            Try different keywords or remove some filters.
          </p>
        </div>
      </div>

      <!-- Search Tips -->
      <div class="card mt-4">
        <h3>Search Tips</h3>
        <ul style="margin-left: 1.5rem; color: var(--text-secondary);">
          <li>Use natural language: "meeting notes from yesterday"</li>
          <li>Search is semantic - it understands context and meaning</li>
          <li>Use filters to narrow down results by type, date, or tags</li>
          <li>Keyboard shortcut: Press <kbd>/</kbd> to focus search</li>
          <li>Results are sorted by relevance - the most similar items appear first</li>
        </ul>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <p>KURA Notes v0.1.0 - Personal Knowledge Management</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="/js/main.js"></script>
  <script>
    const searchForm = document.getElementById('search-form');
    const searchBtn = document.getElementById('search-btn');
    const searchQuery = document.getElementById('search-query');
    const searchResults = document.getElementById('search-results');
    const emptyState = document.getElementById('empty-state');
    const noResults = document.getElementById('no-results');
    const loadingState = document.getElementById('loading-state');
    const resultsContainer = document.getElementById('results-container');
    const resultsCount = document.getElementById('results-count');

    // Display search results
    function displaySearchResults(response) {
      const { results, searchMethod, appliedFilters } = response;

      // Update results count
      const count = results.length;
      const methodText = searchMethod === 'vector' ? 'Semantic Search' :
                         searchMethod === 'fts' ? 'Keyword Search' :
                         'Combined Search';
      resultsCount.textContent = `${count} result${count !== 1 ? 's' : ''} found (${methodText})`;

      // Build results HTML
      const resultsHtml = results.map(result => buildResultItem(result)).join('');

      // Show applied filters if any
      const filtersHtml = appliedFilters && Object.keys(appliedFilters).length > 0
        ? buildAppliedFiltersHtml(appliedFilters)
        : '';

      resultsContainer.innerHTML = `
        ${filtersHtml}
        <div class="search-results-list">
          ${resultsHtml}
        </div>
      `;

      // Show bulk actions toolbar if there are results
      if (results.length > 0) {
        document.getElementById('bulk-actions-toolbar-search').style.display = 'flex';
      }
    }

    // Build a single result item
    function buildResultItem(result) {
      const icon = getContentTypeIcon(result.contentType);
      const displayTitle = result.contentType === 'pdf' && result.metadata?.pdfMetadata?.filename
        ? result.metadata.pdfMetadata.filename
        : (result.title || 'Untitled');
      const title = escapeHtml(displayTitle);
      const excerpt = escapeHtml(result.excerpt || 'No preview available');
      const date = formatRelativeTime(result.createdAt);
      const score = result.score ? (result.score * 100).toFixed(0) : null;

      // Build tags HTML (clickable to filter)
      const tagsHtml = result.tags && result.tags.length > 0
        ? result.tags.map(tag => `<span class="tag tag-clickable" data-tag="${escapeHtml(tag)}" style="cursor: pointer;" title="Click to filter by this tag">${escapeHtml(tag)}</span>`).join('')
        : '';

      // Build relevance score badge (optional, subtle)
      const scoreHtml = score !== null
        ? `<span class="relevance-score" title="Relevance score">${score}%</span>`
        : '';

      // Show thumbnail for images
      const thumbnailHtml = result.contentType === 'image'
        ? `<img src="${API_BASE_URL}/api/content/${result.id}/thumbnail"
                alt="${title}"
                style="width: 80px; height: 80px; object-fit: cover; border-radius: var(--radius-sm); margin-right: var(--spacing-md);"
                onerror="this.outerHTML='<span class=\\'result-icon\\'>${icon}</span>'">`
        : `<span class="result-icon">${icon}</span>`;

      // Add PDF metadata if available
      let pdfInfoHtml = '';
      if (result.contentType === 'pdf' && result.metadata?.pdfMetadata) {
        const sizeKB = Math.round(result.metadata.pdfMetadata.size / 1024);
        const sizeMB = sizeKB > 1024 ? (sizeKB / 1024).toFixed(1) + ' MB' : sizeKB + ' KB';
        const pageInfo = result.metadata.pdfMetadata.pageCount ? `${result.metadata.pdfMetadata.pageCount} pages` : '';
        pdfInfoHtml = `<span class="result-meta-info" style="font-size: 0.875rem; color: var(--text-muted);">
          ${sizeMB}${pageInfo ? ' ‚Ä¢ ' + pageInfo : ''}
        </span>`;
      }

      return `
        <div class="result-item" data-result-id="${result.id}" style="display: flex; align-items: flex-start; position: relative;">
          <input type="checkbox" class="result-checkbox" data-content-id="${result.id}" onclick="event.stopPropagation(); updateSelectionSearch();" style="margin-right: var(--spacing-md); margin-top: var(--spacing-sm); cursor: pointer; flex-shrink: 0;">
          <a href="/view.html?id=${result.id}" style="flex: 1; text-decoration: none; color: inherit;">
            <div class="result-header">
              ${thumbnailHtml}
              <div style="flex: 1;">
                <h3 class="result-title">${title}</h3>
                ${scoreHtml}
              </div>
            </div>
            <p class="result-excerpt">${excerpt}</p>
            <div class="result-meta">
              <span class="result-date">${date}</span>
              <span class="result-type">${result.contentType}</span>
              ${pdfInfoHtml}
              ${tagsHtml ? `<span class="result-tags">${tagsHtml}</span>` : ''}
            </div>
          </a>
        </div>
      `;
    }

    // Build applied filters display
    function buildAppliedFiltersHtml(filters) {
      const filterItems = [];

      if (filters.contentType && filters.contentType.length > 0) {
        filterItems.push(`Type: ${filters.contentType.join(', ')}`);
      }
      if (filters.tags && filters.tags.length > 0) {
        filterItems.push(`Tags: ${filters.tags.join(', ')}`);
      }
      if (filters.dateFrom) {
        filterItems.push(`From: ${new Date(filters.dateFrom).toLocaleDateString()}`);
      }
      if (filters.dateTo) {
        filterItems.push(`To: ${new Date(filters.dateTo).toLocaleDateString()}`);
      }

      if (filterItems.length === 0) return '';

      return `
        <div class="applied-filters">
          <strong>Filters applied:</strong> ${filterItems.join(' ‚Ä¢ ')}
        </div>
      `;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Handle search form submission
    searchForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const query = searchQuery.value.trim();
      if (!query) {
        return;
      }

      // Check API key
      if (!checkApiKey()) {
        return;
      }

      // Get filters
      const formData = new FormData(searchForm);
      const contentTypes = formData.getAll('contentType');
      const dateFrom = formData.get('dateFrom');
      const dateTo = formData.get('dateTo');
      const tagsInput = formData.get('tags');
      const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

      // Build query params
      const params = new URLSearchParams();
      params.set('query', query);
      if (contentTypes.length > 0) {
        params.set('contentType', contentTypes.join(','));
      }
      if (dateFrom) params.set('dateFrom', dateFrom);
      if (dateTo) params.set('dateTo', dateTo);
      if (tags.length > 0) params.set('tags', tags.join(','));

      // Show loading state
      searchBtn.disabled = true;
      searchBtn.innerHTML = 'üîç Searching...';

      // Hide all states and show loading
      emptyState.classList.add('hidden');
      searchResults.classList.add('hidden');
      noResults.classList.add('hidden');
      loadingState.classList.remove('hidden');

      try {
        // Call the search API
        const response = await apiRequest(`/api/search?${params.toString()}`);

        // Hide loading state
        loadingState.classList.add('hidden');

        // Check if we have results
        if (response.results.length === 0) {
          noResults.classList.remove('hidden');
        } else {
          // Display results
          displaySearchResults(response);
          searchResults.classList.remove('hidden');
        }

      } catch (error) {
        console.error('Search failed:', error);

        // Hide loading state
        loadingState.classList.add('hidden');

        // Show error message
        const errorMessage = error.message.includes('503')
          ? 'Search service is currently unavailable. Please ensure OpenAI API key is configured and ChromaDB is running.'
          : error.message.includes('401')
          ? 'Authentication failed. Please check your API key.'
          : error.message || 'Search failed. Please try again.';

        resultsContainer.innerHTML = `
          <div class="message message-error">
            <strong>Search Error</strong>
            <p>${escapeHtml(errorMessage)}</p>
          </div>
        `;
        searchResults.classList.remove('hidden');
      } finally {
        searchBtn.disabled = false;
        searchBtn.innerHTML = 'üîç Search';
      }
    });

    // Clear filters button
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    clearFiltersBtn.addEventListener('click', () => {
      // Reset all content type checkboxes to checked
      document.querySelectorAll('input[name="contentType"]').forEach(cb => {
        cb.checked = true;
      });

      // Clear date inputs
      document.getElementById('date-from').value = '';
      document.getElementById('date-to').value = '';

      // Clear tags input and active filters
      document.getElementById('filter-tags').value = '';
      clearActiveTagFilters();
    });

    // Active tag filters management
    const activeTagFiltersContainer = document.getElementById('active-tag-filters');
    const filterTagsInput = document.getElementById('filter-tags');
    let activeTagFilters = new Set();

    /**
     * Add a tag to active filters
     */
    function addTagFilter(tag) {
      if (!tag || tag.trim().length === 0) return;

      const normalizedTag = tag.trim();
      activeTagFilters.add(normalizedTag);
      updateActiveTagFiltersDisplay();
      updateFilterTagsInput();
    }

    /**
     * Remove a tag from active filters
     */
    function removeTagFilter(tag) {
      activeTagFilters.delete(tag);
      updateActiveTagFiltersDisplay();
      updateFilterTagsInput();
    }

    /**
     * Clear all active tag filters
     */
    function clearActiveTagFilters() {
      activeTagFilters.clear();
      updateActiveTagFiltersDisplay();
      updateFilterTagsInput();
    }

    /**
     * Update the visual display of active tag filters
     */
    function updateActiveTagFiltersDisplay() {
      if (activeTagFilters.size === 0) {
        activeTagFiltersContainer.style.display = 'none';
        activeTagFiltersContainer.innerHTML = '';
        return;
      }

      activeTagFiltersContainer.style.display = 'flex';
      activeTagFiltersContainer.innerHTML = Array.from(activeTagFilters)
        .map(tag => `
          <span class="active-tag-filter" style="
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background-color: var(--accent-color);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
          ">
            ${escapeHtml(tag)}
            <button
              type="button"
              class="remove-tag-filter"
              data-tag="${escapeHtml(tag)}"
              style="
                background: none;
                border: none;
                color: white;
                cursor: pointer;
                padding: 0;
                margin: 0;
                font-size: 1rem;
                line-height: 1;
                opacity: 0.8;
              "
              title="Remove filter"
            >√ó</button>
          </span>
        `).join('');

      // Add click handlers for remove buttons
      activeTagFiltersContainer.querySelectorAll('.remove-tag-filter').forEach(btn => {
        btn.addEventListener('click', () => {
          const tag = btn.getAttribute('data-tag');
          removeTagFilter(tag);
        });
      });
    }

    /**
     * Update the hidden filter-tags input field
     */
    function updateFilterTagsInput() {
      filterTagsInput.value = Array.from(activeTagFilters).join(', ');
    }

    /**
     * Handle clicks on tags in search results
     */
    function handleTagClick(e) {
      if (e.target.classList.contains('tag-clickable')) {
        e.preventDefault();
        const tag = e.target.getAttribute('data-tag');
        addTagFilter(tag);

        // Automatically trigger search with new filter
        searchForm.dispatchEvent(new Event('submit'));
      }
    }

    // Add event listener for tag clicks (use event delegation)
    resultsContainer.addEventListener('click', handleTagClick);

    // Recent searches functionality
    const RECENT_SEARCHES_KEY = 'kura_recent_searches';
    const MAX_RECENT_SEARCHES = 5;

    // Save search query to recent searches
    function saveRecentSearch(query) {
      if (!query || query.trim().length === 0) return;

      let recentSearches = getRecentSearches();

      // Remove if already exists
      recentSearches = recentSearches.filter(s => s !== query);

      // Add to beginning
      recentSearches.unshift(query);

      // Limit to MAX_RECENT_SEARCHES
      recentSearches = recentSearches.slice(0, MAX_RECENT_SEARCHES);

      // Save to localStorage
      localStorage.setItem(RECENT_SEARCHES_KEY, JSON.stringify(recentSearches));
    }

    // Get recent searches from localStorage
    function getRecentSearches() {
      try {
        const searches = localStorage.getItem(RECENT_SEARCHES_KEY);
        return searches ? JSON.parse(searches) : [];
      } catch (e) {
        return [];
      }
    }

    // Display recent searches
    function displayRecentSearches() {
      const recentSearches = getRecentSearches();

      if (recentSearches.length === 0) return;

      const recentSearchesHtml = `
        <div class="card mt-4">
          <h3>Recent Searches</h3>
          <div class="recent-searches">
            ${recentSearches.map(query => `
              <button class="recent-search-item" data-query="${escapeHtml(query)}">
                üîç ${escapeHtml(query)}
              </button>
            `).join('')}
          </div>
        </div>
      `;

      // Insert after search form
      const searchFormCard = document.querySelector('.card');
      searchFormCard.insertAdjacentHTML('afterend', recentSearchesHtml);

      // Add click handlers
      document.querySelectorAll('.recent-search-item').forEach(btn => {
        btn.addEventListener('click', () => {
          const query = btn.getAttribute('data-query');
          searchQuery.value = query;
          searchForm.dispatchEvent(new Event('submit'));
        });
      });
    }

    // Update search form submission to save recent searches
    searchForm.addEventListener('submit', (e) => {
      const query = searchQuery.value.trim();
      if (query) {
        saveRecentSearch(query);
      }
    }, true); // Use capture phase to ensure this runs before the main handler

    // Keyboard shortcut: / to focus search
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
        e.preventDefault();
        searchQuery.focus();
      }
    });

    // Initialize page
    if (window.innerWidth > 768) {
      searchQuery.focus();
    }

    // Check for tag URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const tagParam = urlParams.get('tag');
    if (tagParam) {
      // Add tag to active filters
      addTagFilter(tagParam);

      // Open filters section
      document.getElementById('filters-details').setAttribute('open', '');

      // Set a default search query if none provided
      if (!searchQuery.value || searchQuery.value.trim().length === 0) {
        searchQuery.value = '*';
      }

      // Automatically trigger search
      setTimeout(() => {
        searchForm.dispatchEvent(new Event('submit'));
      }, 100);
    }

    // Selection management for search results
    function updateSelectionSearch() {
      const checkboxes = document.querySelectorAll('.result-checkbox');
      const selectedCheckboxes = document.querySelectorAll('.result-checkbox:checked');
      const selectAllCheckbox = document.getElementById('select-all-checkbox-search');
      const selectionCount = document.getElementById('selection-count-search');

      // Update selection count
      const count = selectedCheckboxes.length;
      selectionCount.textContent = `${count} selected`;

      // Update select all checkbox state
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = count > 0 && count === checkboxes.length;
        selectAllCheckbox.indeterminate = count > 0 && count < checkboxes.length;
      }
    }

    // Handle select all checkbox for search results
    document.addEventListener('DOMContentLoaded', () => {
      const selectAllCheckbox = document.getElementById('select-all-checkbox-search');
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', (e) => {
          const checkboxes = document.querySelectorAll('.result-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = e.target.checked;
          });
          updateSelectionSearch();
        });
      }
    });

    // Get selected content IDs from search results
    function getSelectedIdsSearch() {
      const selectedCheckboxes = document.querySelectorAll('.result-checkbox:checked');
      return Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-content-id'));
    }

    // Bulk delete from search results
    async function bulkDeleteSearch() {
      const selectedIds = getSelectedIdsSearch();

      if (selectedIds.length === 0) {
        alert('Please select items to delete');
        return;
      }

      const confirmed = confirm(`Are you sure you want to delete ${selectedIds.length} item(s)? This action cannot be undone.`);
      if (!confirmed) return;

      try {
        // Show loading state
        const deleteBtn = document.getElementById('bulk-delete-btn-search');
        deleteBtn.disabled = true;
        deleteBtn.textContent = '‚è≥ Deleting...';

        // Call bulk delete API
        const response = await apiRequest('/api/content/bulk/delete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ ids: selectedIds }),
        });

        // Show result
        if (response.success) {
          showMessage(`Successfully deleted ${response.results.successful.length} item(s)`, 'success');
        } else if (response.results.successful.length > 0) {
          showMessage(
            `Partially successful: ${response.results.successful.length} deleted, ${response.results.failed.length} failed`,
            'warning'
          );
        } else {
          showMessage('Failed to delete items', 'error');
        }

        // Re-run search to update results
        searchForm.dispatchEvent(new Event('submit'));
      } catch (error) {
        console.error('Bulk delete failed:', error);
        alert(`Failed to delete items: ${error.message}`);

        // Restore button
        const deleteBtn = document.getElementById('bulk-delete-btn-search');
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'üóëÔ∏è Delete Selected';
      }
    }

    // Bulk add tags from search results
    async function bulkAddTagsSearch() {
      const selectedIds = getSelectedIdsSearch();

      if (selectedIds.length === 0) {
        alert('Please select items to add tags');
        return;
      }

      const tagsInput = prompt(`Add tags to ${selectedIds.length} item(s)\n(comma-separated, e.g., work, important):`);
      if (!tagsInput) return;

      const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
      if (tags.length === 0) {
        alert('Please enter at least one tag');
        return;
      }

      try {
        // Show loading state
        const tagBtn = document.getElementById('bulk-tag-btn-search');
        tagBtn.disabled = true;
        tagBtn.textContent = '‚è≥ Adding tags...';

        // Call bulk tag API
        const response = await apiRequest('/api/content/bulk/tag', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            ids: selectedIds,
            tags: tags,
            mode: 'add'
          }),
        });

        // Show result
        if (response.success) {
          showMessage(`Successfully added tags to ${response.results.successful.length} item(s)`, 'success');
        } else if (response.results.successful.length > 0) {
          showMessage(
            `Partially successful: ${response.results.successful.length} updated, ${response.results.failed.length} failed`,
            'warning'
          );
        } else {
          showMessage('Failed to add tags', 'error');
        }

        // Re-run search to update results
        searchForm.dispatchEvent(new Event('submit'));
      } catch (error) {
        console.error('Bulk tag operation failed:', error);
        alert(`Failed to add tags: ${error.message}`);

        // Restore button
        const tagBtn = document.getElementById('bulk-tag-btn-search');
        tagBtn.disabled = false;
        tagBtn.textContent = 'üè∑Ô∏è Add Tags';
      }
    }

    // Display recent searches on page load
    displayRecentSearches();
  </script>
</body>
</html>
