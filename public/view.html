<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="KURA Notes - View Content">
  <title>View Content - KURA Notes</title>
  <link rel="stylesheet" href="/css/main.css">
</head>
<body>
  <!-- Header / Navigation -->
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a href="/" class="nav-brand">
          <span>üìö</span>
          <span>KURA Notes</span>
        </a>
        <ul class="nav-menu">
          <li><a href="/" class="nav-link">Home</a></li>
          <li><a href="/create.html" class="nav-link">Create Note</a></li>
          <li><a href="/upload.html" class="nav-link">Upload File</a></li>
          <li><a href="/search.html" class="nav-link">Search</a></li>
          <li><a href="/tags.html" class="nav-link">Tags</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="container container-narrow">
      <!-- Back Button -->
      <div class="mb-3">
        <a href="/" class="btn btn-secondary">
          ‚Üê Back to Home
        </a>
      </div>

      <!-- Content Container -->
      <div id="content-container">
        <!-- Loading state will be shown here -->
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>Loading content...</p>
        </div>
      </div>

      <!-- Action Buttons (shown after content loads) -->
      <div id="content-actions" class="hidden mt-4">
        <div class="grid grid-cols-2">
          <button class="btn btn-secondary" onclick="window.history.back()">
            ‚Üê Back
          </button>
          <button class="btn btn-danger" id="delete-btn" onclick="deleteContent()">
            üóëÔ∏è Delete
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <p>KURA Notes v0.1.0 - Personal Knowledge Management</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="/js/main.js"></script>
  <script>
    // Get content ID from URL
    function getContentIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    // Load and display content
    async function loadContent() {
      const contentId = getContentIdFromUrl();

      if (!contentId) {
        showError('No content ID provided');
        return;
      }

      const container = document.getElementById('content-container');

      try {
        const data = await apiRequest(`/api/content/${contentId}`);

        // Build metadata HTML
        const metadataHtml = buildMetadataHtml(data);

        // Build content HTML based on content type
        const contentHtml = buildContentHtml(data);

        // Display content
        container.innerHTML = `
          <div class="card">
            <div class="content-view">
              ${metadataHtml}
              <div class="content-divider"></div>
              ${contentHtml}
            </div>
          </div>
        `;

        // Show action buttons
        document.getElementById('content-actions').classList.remove('hidden');
      } catch (error) {
        console.error('Failed to load content:', error);
        showError(error.message || 'Failed to load content. Please try again.');
      }
    }

    // Build metadata section
    function buildMetadataHtml(data) {
      const icon = getContentTypeIcon(data.content_type);
      const title = data.title || 'Untitled';
      const createdDate = new Date(data.created_at).toLocaleString();
      const updatedDate = new Date(data.updated_at).toLocaleString();
      const relativeTime = formatRelativeTime(data.created_at);

      const tagsHtml = data.tags && data.tags.length > 0
        ? `
          <div class="metadata-row">
            <div class="metadata-label">Tags</div>
            <div class="metadata-value">
              ${data.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
            </div>
          </div>
        `
        : '';

      const annotationHtml = data.annotation
        ? `
          <div class="metadata-row">
            <div class="metadata-label">Annotation</div>
            <div class="metadata-value">${escapeHtml(data.annotation)}</div>
          </div>
        `
        : '';

      // Add image metadata if available
      let imageMetadataHtml = '';
      if (data.content_type === 'image' && data.image_metadata) {
        const meta = data.image_metadata;
        const sizeKB = Math.round(meta.size / 1024);
        const sizeMB = sizeKB > 1024 ? (sizeKB / 1024).toFixed(2) + ' MB' : sizeKB + ' KB';

        imageMetadataHtml = `
          <div class="metadata-row">
            <div class="metadata-label">Dimensions</div>
            <div class="metadata-value">${meta.width} √ó ${meta.height} px</div>
          </div>
          <div class="metadata-row">
            <div class="metadata-label">Format</div>
            <div class="metadata-value">${meta.format.toUpperCase()}</div>
          </div>
          <div class="metadata-row">
            <div class="metadata-label">File Size</div>
            <div class="metadata-value">${sizeMB}</div>
          </div>
        `;
      }

      // Add PDF metadata if available
      let pdfMetadataHtml = '';
      if (data.content_type === 'pdf' && data.pdf_metadata) {
        const meta = data.pdf_metadata;
        const sizeKB = Math.round(meta.size / 1024);
        const sizeMB = sizeKB > 1024 ? (sizeKB / 1024).toFixed(2) + ' MB' : sizeKB + ' KB';

        pdfMetadataHtml = `
          <div class="metadata-row">
            <div class="metadata-label">Filename</div>
            <div class="metadata-value">${escapeHtml(meta.filename)}</div>
          </div>
          ${meta.pageCount ? `
          <div class="metadata-row">
            <div class="metadata-label">Pages</div>
            <div class="metadata-value">${meta.pageCount}</div>
          </div>
          ` : ''}
          <div class="metadata-row">
            <div class="metadata-label">File Size</div>
            <div class="metadata-value">${sizeMB}${meta.size > 10 * 1024 * 1024 ? ' <span style="color: var(--warning-color);">‚ö†Ô∏è Large file</span>' : ''}</div>
          </div>
        `;
      }

      return `
        <div class="content-header">
          <div class="content-icon">${icon}</div>
          <div>
            <h1 class="content-title">${escapeHtml(title)}</h1>
            <p class="content-meta">
              Created ${relativeTime} ‚Ä¢ ${data.content_type}
              ${data.source ? ` ‚Ä¢ via ${data.source}` : ''}
            </p>
          </div>
        </div>

        <div class="metadata-section">
          ${annotationHtml}
          ${imageMetadataHtml}
          ${pdfMetadataHtml}
          ${tagsHtml}
          <div class="metadata-row">
            <div class="metadata-label">Created</div>
            <div class="metadata-value">${createdDate}</div>
          </div>
          <div class="metadata-row">
            <div class="metadata-label">Updated</div>
            <div class="metadata-value">${updatedDate}</div>
          </div>
          <div class="metadata-row">
            <div class="metadata-label">ID</div>
            <div class="metadata-value"><code>${data.id}</code></div>
          </div>
        </div>
      `;
    }

    // Build content section based on type
    function buildContentHtml(data) {
      if (data.content_type === 'text') {
        return `
          <div class="content-body">
            <h2 class="content-section-title">Content</h2>
            <div class="content-text">${escapeHtml(data.content).replace(/\n/g, '<br>')}</div>
          </div>
        `;
      } else if (data.content_type === 'image') {
        // Display image inline with zoom modal
        const imageUrl = `${API_BASE_URL}/api/content/${data.id}/file`;
        const title = data.title || 'Image';
        return `
          <div class="content-body">
            <h2 class="content-section-title">Image</h2>
            <div style="text-align: center; margin-top: var(--spacing-lg);">
              <img
                id="content-image"
                src="${imageUrl}"
                alt="${escapeHtml(title)}"
                style="max-width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: zoom-in;"
                onclick="openImageModal('${imageUrl}', '${escapeHtml(title)}')"
              />
              <p style="margin-top: var(--spacing-sm); font-size: 0.875rem; color: var(--text-muted);">
                Click image to view fullscreen
              </p>
            </div>
          </div>

          <!-- Image Modal -->
          <div id="image-modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); cursor: zoom-out;" onclick="closeImageModal()">
            <span style="position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;" onclick="closeImageModal()">&times;</span>
            <img id="modal-image" style="margin: auto; display: block; max-width: 90%; max-height: 90%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
          </div>

          <script>
            function openImageModal(imageUrl, title) {
              const modal = document.getElementById('image-modal');
              const modalImg = document.getElementById('modal-image');
              modal.style.display = 'block';
              modalImg.src = imageUrl;
              modalImg.alt = title;
            }

            function closeImageModal() {
              document.getElementById('image-modal').style.display = 'none';
            }

            // Close modal with Escape key
            document.addEventListener('keydown', function(event) {
              if (event.key === 'Escape') {
                closeImageModal();
              }
            });
          </script>
        `;
      } else if (data.content_type === 'pdf') {
        // Enhanced PDF display with iframe viewer and download options
        const pdfUrl = `${API_BASE_URL}/api/content/${data.id}/file`;
        const downloadUrl = `${API_BASE_URL}/api/content/${data.id}/download`;
        const title = data.title || data.pdf_metadata?.filename || 'Document';
        const fileSize = data.pdf_metadata?.size || 0;
        const isLarge = fileSize > 10 * 1024 * 1024; // >10MB

        // Show iframe for smaller PDFs, download button for larger ones
        const viewerHtml = isLarge ?
          `<div style="padding: var(--spacing-xl); background-color: var(--bg-secondary); border-radius: var(--radius-md); border: 2px dashed var(--border-color); text-align: center;">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üìÑ</div>
            <h3 style="margin-bottom: var(--spacing-md);">${escapeHtml(title)}</h3>
            <p style="color: var(--text-muted); margin-bottom: var(--spacing-md);">
              ‚ö†Ô∏è Large PDF file - download to view
            </p>
            <a href="${downloadUrl}" class="btn btn-primary" style="margin-right: var(--spacing-sm);">
              ‚¨áÔ∏è Download PDF
            </a>
            <a href="${pdfUrl}" class="btn btn-secondary" target="_blank">
              üëÅÔ∏è Open in New Tab
            </a>
          </div>`
          :
          `<div style="margin-bottom: var(--spacing-md); text-align: center;">
            <a href="${downloadUrl}" class="btn btn-primary" style="margin-right: var(--spacing-sm);">
              ‚¨áÔ∏è Download PDF
            </a>
            <a href="${pdfUrl}" class="btn btn-secondary" target="_blank">
              üëÅÔ∏è Open in New Tab
            </a>
          </div>
          <iframe
            src="${pdfUrl}"
            style="width: 100%; height: 600px; border: 1px solid var(--border-color); border-radius: var(--radius-md);"
            title="${escapeHtml(title)}"
          ></iframe>
          <p style="margin-top: var(--spacing-sm); font-size: 0.875rem; color: var(--text-muted); text-align: center;">
            PDF viewer (${data.pdf_metadata?.pageCount ? data.pdf_metadata.pageCount + ' pages' : 'viewing inline'})
          </p>`;

        return `
          <div class="content-body">
            <h2 class="content-section-title">PDF Document</h2>
            <div style="margin-top: var(--spacing-lg);">
              ${viewerHtml}
            </div>
          </div>
        `;
      } else {
        return `
          <div class="content-body">
            <h2 class="content-section-title">Content</h2>
            <p class="text-muted">Unsupported content type: ${data.content_type}</p>
          </div>
        `;
      }
    }

    // Show error message
    function showError(message) {
      const container = document.getElementById('content-container');
      container.innerHTML = `
        <div class="card">
          <div class="error-state">
            <h2>Error</h2>
            <p class="text-error">${escapeHtml(message)}</p>
            <a href="/" class="btn btn-primary mt-3">Return to Home</a>
          </div>
        </div>
      `;
    }

    // Delete content
    async function deleteContent() {
      const contentId = getContentIdFromUrl();

      if (!contentId) {
        alert('No content ID found');
        return;
      }

      // Show confirmation dialog
      const confirmed = confirm('Are you sure you want to delete this content? This action cannot be undone.');

      if (!confirmed) {
        return;
      }

      // Show loading state
      const deleteBtn = document.getElementById('delete-btn');
      const originalBtnText = deleteBtn.innerHTML;
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '‚è≥ Deleting...';

      try {
        // Call DELETE endpoint using apiRequest helper
        const data = await apiRequest(`/api/content/${contentId}`, {
          method: 'DELETE',
        });

        // Show success message and redirect to home
        alert('Content deleted successfully');
        window.location.href = '/';
      } catch (error) {
        console.error('Failed to delete content:', error);

        // Show error message
        alert(error.message || 'Failed to delete content. Please try again.');

        // Restore button state
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalBtnText;
      }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadContent);
    } else {
      loadContent();
    }
  </script>
</body>
</html>
