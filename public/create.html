<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Create a new note in KURA Notes">
  <title>Create Note - KURA Notes</title>
  <link rel="stylesheet" href="/css/main.css">
</head>
<body>
  <!-- Header / Navigation -->
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a href="/" class="nav-brand">
          <span>ðŸ“š</span>
          <span>KURA Notes</span>
        </a>
        <ul class="nav-menu">
          <li><a href="/" class="nav-link">Home</a></li>
          <li><a href="/create.html" class="nav-link">Create Note</a></li>
          <li><a href="/upload.html" class="nav-link">Upload File</a></li>
          <li><a href="/search.html" class="nav-link">Search</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="container container-narrow">
      <h1>Create New Note</h1>
      <p class="text-muted mb-4">
        Write a text note with optional tags and context
      </p>

      <!-- Create Note Form -->
      <div class="card">
        <form id="create-note-form">
          <!-- Title Field -->
          <div class="form-group">
            <label for="title" class="form-label">
              Title (optional)
              <span class="char-counter" id="title-counter">0/200</span>
            </label>
            <input
              type="text"
              id="title"
              name="title"
              class="form-input"
              placeholder="Enter a title for your note"
              maxlength="200"
            >
            <span class="form-help">A descriptive title helps you find this note later</span>
            <span class="form-error" id="title-error"></span>
          </div>

          <!-- Content Field -->
          <div class="form-group">
            <label for="content" class="form-label">Content *</label>
            <textarea
              id="content"
              name="content"
              class="form-textarea auto-resize"
              placeholder="Write your note here..."
              required
              rows="10"
            ></textarea>
            <span class="form-help">The main content of your note (required)</span>
            <span class="form-error" id="content-error"></span>
          </div>

          <!-- Annotation Field -->
          <div class="form-group">
            <label for="annotation" class="form-label">Annotation (optional)</label>
            <textarea
              id="annotation"
              name="annotation"
              class="form-textarea auto-resize"
              placeholder="Add context, thoughts, or related information..."
              rows="3"
            ></textarea>
            <span class="form-help">Additional context that helps with search and understanding</span>
            <span class="form-error" id="annotation-error"></span>
          </div>

          <!-- Tags Field -->
          <div class="form-group">
            <label for="tags" class="form-label">Tags (optional)</label>
            <input
              type="text"
              id="tags"
              name="tags"
              class="form-input"
              placeholder="personal, work, ideas (comma-separated)"
            >
            <span class="form-help">Comma-separated tags (letters, numbers, dashes, underscores only)</span>
            <span class="form-error" id="tags-error"></span>
          </div>

          <!-- Form Actions -->
          <div class="form-group">
            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
              ðŸ’¾ Save Note
            </button>
            <button type="button" class="btn btn-secondary" onclick="clearForm()">
              Clear
            </button>
          </div>
        </form>

        <!-- Success/Error Messages -->
        <div id="form-message" class="hidden"></div>
      </div>

      <!-- Keyboard Shortcuts Info -->
      <div class="card mt-4">
        <h3>Keyboard Shortcuts</h3>
        <p class="text-muted" style="font-size: 0.875rem;">
          <strong>Cmd/Ctrl + Enter:</strong> Save note<br>
          <strong>Esc:</strong> Clear form
        </p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <p>KURA Notes v0.1.0 - Personal Knowledge Management</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="/js/main.js"></script>
  <script>
    const form = document.getElementById('create-note-form');
    const submitBtn = document.getElementById('submit-btn');
    const messageEl = document.getElementById('form-message');

    // Form fields
    const titleInput = document.getElementById('title');
    const contentTextarea = document.getElementById('content');
    const annotationTextarea = document.getElementById('annotation');
    const tagsInput = document.getElementById('tags');

    // Error display elements
    const titleError = document.getElementById('title-error');
    const contentError = document.getElementById('content-error');
    const annotationError = document.getElementById('annotation-error');
    const tagsError = document.getElementById('tags-error');

    // Character counter
    const titleCounter = document.getElementById('title-counter');

    // Validation patterns
    const TAG_PATTERN = /^[a-zA-Z0-9-_]+$/;
    const MAX_TITLE_LENGTH = 200;
    const MAX_CONTENT_LENGTH = 1000000; // 1MB
    const MAX_ANNOTATION_LENGTH = 5000;
    const MAX_TAG_LENGTH = 50;
    const MAX_TAGS = 20;

    // Auto-resize textarea function
    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    // Initialize auto-resize for all textareas
    document.querySelectorAll('.auto-resize').forEach(textarea => {
      textarea.addEventListener('input', () => autoResize(textarea));
      // Initial resize
      autoResize(textarea);
    });

    // Update character counter
    function updateCharCounter() {
      const count = titleInput.value.length;
      titleCounter.textContent = `${count}/${MAX_TITLE_LENGTH}`;

      if (count > MAX_TITLE_LENGTH * 0.9) {
        titleCounter.style.color = 'var(--warning-color)';
      } else {
        titleCounter.style.color = 'var(--text-muted)';
      }
    }

    titleInput.addEventListener('input', updateCharCounter);

    // Validation functions
    function showError(input, errorEl, message) {
      input.classList.add('invalid');
      errorEl.textContent = message;
      return false;
    }

    function clearError(input, errorEl) {
      input.classList.remove('invalid');
      errorEl.textContent = '';
      return true;
    }

    function validateTitle() {
      const value = titleInput.value.trim();

      if (value && value.length > MAX_TITLE_LENGTH) {
        return showError(titleInput, titleError, `Title must be ${MAX_TITLE_LENGTH} characters or less`);
      }

      return clearError(titleInput, titleError);
    }

    function validateContent() {
      const value = contentTextarea.value.trim();

      if (!value) {
        return showError(contentTextarea, contentError, 'Content is required');
      }

      if (value.length > MAX_CONTENT_LENGTH) {
        return showError(contentTextarea, contentError, 'Content is too long');
      }

      return clearError(contentTextarea, contentError);
    }

    function validateAnnotation() {
      const value = annotationTextarea.value.trim();

      if (value && value.length > MAX_ANNOTATION_LENGTH) {
        return showError(annotationTextarea, annotationError, `Annotation must be ${MAX_ANNOTATION_LENGTH} characters or less`);
      }

      return clearError(annotationTextarea, annotationError);
    }

    function validateTags() {
      const value = tagsInput.value.trim();

      if (!value) {
        return clearError(tagsInput, tagsError);
      }

      // Parse tags
      const tags = value.split(',').map(t => t.trim()).filter(t => t);

      if (tags.length > MAX_TAGS) {
        return showError(tagsInput, tagsError, `Maximum ${MAX_TAGS} tags allowed`);
      }

      // Validate each tag
      for (const tag of tags) {
        if (tag.length > MAX_TAG_LENGTH) {
          return showError(tagsInput, tagsError, `Tag "${tag}" is too long (max ${MAX_TAG_LENGTH} characters)`);
        }

        if (!TAG_PATTERN.test(tag)) {
          return showError(tagsInput, tagsError, `Tag "${tag}" contains invalid characters. Use only letters, numbers, dashes, and underscores.`);
        }
      }

      return clearError(tagsInput, tagsError);
    }

    function validateForm() {
      const isTitleValid = validateTitle();
      const isContentValid = validateContent();
      const isAnnotationValid = validateAnnotation();
      const areTagsValid = validateTags();

      return isTitleValid && isContentValid && isAnnotationValid && areTagsValid;
    }

    // Add blur validation
    titleInput.addEventListener('blur', validateTitle);
    contentTextarea.addEventListener('blur', validateContent);
    annotationTextarea.addEventListener('blur', validateAnnotation);
    tagsInput.addEventListener('blur', validateTags);

    // Clear form
    function clearForm() {
      form.reset();
      messageEl.className = 'hidden';
      clearError(titleInput, titleError);
      clearError(contentTextarea, contentError);
      clearError(annotationTextarea, annotationError);
      clearError(tagsInput, tagsError);
      updateCharCounter();

      // Reset textarea heights
      document.querySelectorAll('.auto-resize').forEach(textarea => {
        autoResize(textarea);
      });
    }

    // Show message
    function showFormMessage(message, type) {
      messageEl.textContent = message;
      messageEl.className = `message message-${type}`;
      messageEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate form
      if (!validateForm()) {
        showFormMessage('Please fix the errors before submitting', 'error');
        return;
      }

      // Check API key
      if (!checkApiKey()) {
        return;
      }

      // Get form data
      const formData = new FormData(form);
      const title = formData.get('title');
      const content = formData.get('content');
      const annotation = formData.get('annotation');
      const tagsInput = formData.get('tags');

      // Parse tags
      const tags = tagsInput
        ? tagsInput.split(',').map(t => t.trim()).filter(t => t)
        : [];

      // Prepare request body
      const body = {
        contentType: 'text',
        content: content,
        ...(title && { title }),
        ...(annotation && { annotation }),
        ...(tags.length > 0 && { tags }),
      };

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> Saving...';

      try {
        // Make API request
        const response = await apiRequest('/api/capture', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(body),
        });

        // Show success message
        showFormMessage('Note saved successfully! Redirecting...', 'success');

        // Clear form after short delay
        setTimeout(() => {
          window.location.href = '/';
        }, 1500);

      } catch (error) {
        console.error('Failed to save note:', error);
        showFormMessage(`Failed to save note: ${error.message}`, 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'ðŸ’¾ Save Note';
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + Enter to submit
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault();
        form.requestSubmit();
      }

      // Esc to clear
      if (e.key === 'Escape') {
        clearForm();
      }
    });

    // Auto-focus content field
    contentTextarea.focus();
  </script>
</body>
</html>
