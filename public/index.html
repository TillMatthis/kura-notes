<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="KURA Notes - Personal Knowledge Management System">
  <title>KURA Notes - Home</title>
  <link rel="stylesheet" href="/css/main.css">
</head>
<body>
  <!-- Header / Navigation -->
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a href="/" class="nav-brand">
          <span>üìö</span>
          <span>KURA Notes</span>
        </a>
        <ul class="nav-menu">
          <li><a href="/" class="nav-link">Home</a></li>
          <li><a href="/create.html" class="nav-link">Create Note</a></li>
          <li><a href="/upload.html" class="nav-link">Upload File</a></li>
          <li><a href="/search.html" class="nav-link">Search</a></li>
          <li><a href="/tags.html" class="nav-link">Tags</a></li>
          <li>
            <button class="settings-button" onclick="openSettings()" aria-label="Settings" title="Settings">
              <span class="api-status-indicator" id="api-status-indicator"></span>
              <span>‚öôÔ∏è</span>
            </button>
          </li>
        </ul>
        <div class="user-menu" id="user-menu" style="display: none;">
          <span id="user-email" class="user-email"></span>
          <button onclick="logout()" class="logout-button">Logout</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="container">
      <!-- Welcome Section -->
      <div class="text-center mb-4">
        <h1>Welcome to KURA Notes</h1>
        <p class="text-muted">
          Your personal knowledge management system with semantic search
        </p>
      </div>

      <!-- Quick Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Items</div>
          <div class="stat-value" id="stat-total">
            <div class="loading-spinner-sm"></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Text Notes</div>
          <div class="stat-value" id="stat-text">
            <div class="loading-spinner-sm"></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Images</div>
          <div class="stat-value" id="stat-images">
            <div class="loading-spinner-sm"></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">PDFs</div>
          <div class="stat-value" id="stat-pdfs">
            <div class="loading-spinner-sm"></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Storage Used</div>
          <div class="stat-value" id="stat-storage">
            <div class="loading-spinner-sm"></div>
          </div>
        </div>
      </div>

      <!-- Top Tags Section -->
      <div class="card mb-4" id="top-tags-section" style="display: none;">
        <div class="card-header">
          <h3 class="card-title">Most Used Tags</h3>
          <p class="card-description">Your top 10 most frequently used tags</p>
        </div>
        <div id="top-tags-list" class="tag-cloud"></div>
      </div>

      <!-- Quick Actions -->
      <div class="card mb-4">
        <div class="card-header">
          <h2 class="card-title">Quick Actions</h2>
          <p class="card-description">Get started with KURA Notes</p>
        </div>

        <div class="grid grid-cols-3">
          <a href="/create.html" class="btn btn-primary btn-lg">
            üìù Create Note
          </a>
          <a href="/upload.html" class="btn btn-secondary btn-lg">
            üì§ Upload File
          </a>
          <a href="/search.html" class="btn btn-secondary btn-lg">
            üîç Search
          </a>
        </div>
      </div>

      <!-- Recent Items Placeholder -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Recent Items</h2>
          <p class="card-description">Your recently added content</p>
        </div>

        <!-- Bulk Actions Toolbar -->
        <div id="bulk-actions-toolbar" class="bulk-actions-toolbar" style="display: none;">
          <div style="display: flex; align-items: center; gap: var(--spacing-md);">
            <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer;">
              <input type="checkbox" id="select-all-checkbox" style="cursor: pointer;">
              <span id="selection-count" style="font-weight: 500;">0 selected</span>
            </label>
          </div>
          <div style="display: flex; gap: var(--spacing-sm);">
            <button type="button" class="btn btn-danger btn-sm" id="bulk-delete-btn" onclick="bulkDelete()">
              üóëÔ∏è Delete Selected
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="bulk-tag-btn" onclick="bulkAddTags()">
              üè∑Ô∏è Add Tags
            </button>
          </div>
        </div>

        <div id="recent-items">
          <p class="text-muted text-center">
            No items yet. Create your first note or upload a file to get started!
          </p>
        </div>
      </div>

      <!-- Getting Started Info -->
      <div class="card mt-4">
        <div class="card-header">
          <h3 class="card-title">Getting Started</h3>
        </div>
        <div>
          <p><strong>What is KURA Notes?</strong></p>
          <p>
            KURA Notes is your personal knowledge management system. Capture text notes,
            images, and PDFs, then find them later using powerful semantic search.
          </p>

          <p class="mt-3"><strong>Quick Guide:</strong></p>
          <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
            <li>Create text notes with tags and annotations</li>
            <li>Upload images and PDFs for safekeeping</li>
            <li>Search using natural language queries</li>
            <li>Use the iOS shortcut to capture on-the-go</li>
          </ul>

          <p class="mt-3"><strong>Keyboard Shortcuts:</strong></p>
          <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
            <li><kbd>/</kbd> - Open search</li>
            <li><kbd>n</kbd> - Create new note</li>
            <li><kbd>Esc</kbd> - Close modals / Clear forms</li>
            <li><kbd>Cmd/Ctrl+Enter</kbd> - Save note (in forms)</li>
          </ul>

          <p class="mt-3 text-muted" style="font-size: 0.875rem;">
            <strong>Note:</strong> This is the MVP version. More features coming soon!
          </p>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <p>KURA Notes v0.1.0 - Personal Knowledge Management</p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="/js/main.js"></script>
  <script src="/js/settings.js"></script>
  <script>
    // Load stats on page load
    async function loadStats() {
      try {
        const response = await apiRequest('/api/stats');

        if (!response.success || !response.data) {
          throw new Error('Failed to load stats');
        }

        const stats = response.data;

        // Update main stat cards
        document.getElementById('stat-total').textContent = stats.totalItems || 0;
        document.getElementById('stat-text').textContent = stats.byContentType.text || 0;
        document.getElementById('stat-images').textContent = stats.byContentType.image || 0;
        document.getElementById('stat-pdfs').textContent = stats.byContentType.pdf || 0;
        document.getElementById('stat-storage').textContent = stats.storageUsed?.formatted || '0 B';

        // Display top tags
        if (stats.mostUsedTags && stats.mostUsedTags.length > 0) {
          const topTagsSection = document.getElementById('top-tags-section');
          const topTagsList = document.getElementById('top-tags-list');

          const tagsHtml = stats.mostUsedTags.map((item, index) => {
            // Calculate size based on usage (larger for more used tags)
            const maxSize = 1.5;
            const minSize = 0.9;
            const size = minSize + ((maxSize - minSize) * (1 - index / stats.mostUsedTags.length));

            return `
              <a href="/search.html?tag=${encodeURIComponent(item.tag)}"
                 class="tag tag-clickable"
                 style="font-size: ${size}rem;">
                ${escapeHtml(item.tag)} <span class="tag-count">(${item.count})</span>
              </a>
            `;
          }).join('');

          topTagsList.innerHTML = tagsHtml;
          topTagsSection.style.display = 'block';
        }

        console.log('Stats loaded successfully:', stats);
      } catch (error) {
        console.error('Failed to load stats:', error);

        // Show 0s on error
        document.getElementById('stat-total').textContent = '0';
        document.getElementById('stat-text').textContent = '0';
        document.getElementById('stat-images').textContent = '0';
        document.getElementById('stat-pdfs').textContent = '0';
        document.getElementById('stat-storage').textContent = '0 B';
      }
    }

    // Load recent items
    async function loadRecentItems() {
      const container = document.getElementById('recent-items');

      // Show loading state
      container.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><p>Loading recent items...</p></div>';

      try {
        const data = await apiRequest('/api/content/recent');

        // Check if there are any items
        if (!data.items || data.items.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p class="text-muted text-center">
                No items yet. Create your first note or upload a file to get started!
              </p>
            </div>
          `;
          return;
        }

        // Build HTML for recent items with checkboxes
        const itemsHtml = data.items.map(item => {
          const icon = getContentTypeIcon(item.content_type);
          const relativeTime = formatRelativeTime(item.created_at);
          const title = item.title || item.annotation || (item.content_type === 'pdf' && item.pdf_metadata ? item.pdf_metadata.filename : 'Untitled');
          const tagsHtml = item.tags && item.tags.length > 0
            ? item.tags.map(tag => `<span class="tag">${tag}</span>`).join('')
            : '';

          // Show thumbnail for images
          const thumbnailHtml = item.content_type === 'image'
            ? `<div class="item-thumbnail">
                 <img src="${API_BASE_URL}/api/content/${item.id}/thumbnail"
                      alt="${escapeHtml(title)}"
                      loading="lazy"
                      style="width: 80px; height: 80px; object-fit: cover; border-radius: var(--radius-sm);"
                      onerror="this.parentElement.innerHTML='<div class=\\'item-icon\\'>${icon}</div>'">
               </div>`
            : `<div class="item-icon">${icon}</div>`;

          // Add PDF metadata if available
          let pdfInfoHtml = '';
          if (item.content_type === 'pdf' && item.pdf_metadata) {
            const sizeKB = Math.round(item.pdf_metadata.size / 1024);
            const sizeMB = sizeKB > 1024 ? (sizeKB / 1024).toFixed(1) + ' MB' : sizeKB + ' KB';
            const pageInfo = item.pdf_metadata.pageCount ? `${item.pdf_metadata.pageCount} pages` : '';
            pdfInfoHtml = `<p class="item-meta" style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.25rem;">
              ${sizeMB}${pageInfo ? ' ‚Ä¢ ' + pageInfo : ''}
            </p>`;
          }

          return `
            <div class="item-card" data-item-id="${item.id}">
              <input type="checkbox" class="item-checkbox" data-content-id="${item.id}" onclick="event.stopPropagation(); updateSelection();" style="margin-right: var(--spacing-md); cursor: pointer;">
              <div onclick="viewContent('${item.id}')" style="display: flex; flex: 1; cursor: pointer;">
                ${thumbnailHtml}
                <div class="item-content">
                  <div class="item-header">
                    <h3 class="item-title">${escapeHtml(title)}</h3>
                    <span class="item-date">${relativeTime}</span>
                  </div>
                  ${item.annotation && item.title !== item.annotation ? `<p class="item-annotation">${escapeHtml(item.annotation)}</p>` : ''}
                  ${pdfInfoHtml}
                  ${tagsHtml ? `<div class="item-tags">${tagsHtml}</div>` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = `<div class="items-list">${itemsHtml}</div>`;

        // Show bulk actions toolbar if there are items
        if (data.items.length > 0) {
          document.getElementById('bulk-actions-toolbar').style.display = 'flex';
        }
      } catch (error) {
        console.error('Failed to load recent items:', error);
        container.innerHTML = `
          <div class="error-state">
            <p class="text-error text-center">
              Failed to load recent items. Please try again later.
            </p>
          </div>
        `;
      }
    }

    // Navigate to content view page
    function viewContent(contentId) {
      window.location.href = `/view.html?id=${contentId}`;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Update selection state
    function updateSelection() {
      const checkboxes = document.querySelectorAll('.item-checkbox');
      const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
      const selectAllCheckbox = document.getElementById('select-all-checkbox');
      const selectionCount = document.getElementById('selection-count');

      // Update selection count
      const count = selectedCheckboxes.length;
      selectionCount.textContent = `${count} selected`;

      // Update select all checkbox state
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = count > 0 && count === checkboxes.length;
        selectAllCheckbox.indeterminate = count > 0 && count < checkboxes.length;
      }
    }

    // Handle select all checkbox
    document.addEventListener('DOMContentLoaded', () => {
      const selectAllCheckbox = document.getElementById('select-all-checkbox');
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', (e) => {
          const checkboxes = document.querySelectorAll('.item-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = e.target.checked;
          });
          updateSelection();
        });
      }
    });

    // Get selected content IDs
    function getSelectedIds() {
      const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
      return Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-content-id'));
    }

    // Bulk delete selected items
    async function bulkDelete() {
      const selectedIds = getSelectedIds();

      if (selectedIds.length === 0) {
        alert('Please select items to delete');
        return;
      }

      const confirmed = confirm(`Are you sure you want to delete ${selectedIds.length} item(s)? This action cannot be undone.`);
      if (!confirmed) return;

      try {
        // Show loading state
        const deleteBtn = document.getElementById('bulk-delete-btn');
        const originalText = deleteBtn.textContent;
        deleteBtn.disabled = true;
        deleteBtn.textContent = '‚è≥ Deleting...';

        // Call bulk delete API
        const response = await apiRequest('/api/content/bulk/delete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ ids: selectedIds }),
        });

        // Show result
        if (response.success) {
          showMessage(`Successfully deleted ${response.results.successful.length} item(s)`, 'success');
        } else if (response.results.successful.length > 0) {
          showMessage(
            `Partially successful: ${response.results.successful.length} deleted, ${response.results.failed.length} failed`,
            'warning'
          );
        } else {
          showMessage('Failed to delete items', 'error');
        }

        // Reload items
        await loadRecentItems();
      } catch (error) {
        console.error('Bulk delete failed:', error);
        alert(`Failed to delete items: ${error.message}`);

        // Restore button
        const deleteBtn = document.getElementById('bulk-delete-btn');
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'üóëÔ∏è Delete Selected';
      }
    }

    // Bulk add tags to selected items
    async function bulkAddTags() {
      const selectedIds = getSelectedIds();

      if (selectedIds.length === 0) {
        alert('Please select items to add tags');
        return;
      }

      const tagsInput = prompt(`Add tags to ${selectedIds.length} item(s)\n(comma-separated, e.g., work, important):`);
      if (!tagsInput) return;

      const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
      if (tags.length === 0) {
        alert('Please enter at least one tag');
        return;
      }

      try {
        // Show loading state
        const tagBtn = document.getElementById('bulk-tag-btn');
        const originalText = tagBtn.textContent;
        tagBtn.disabled = true;
        tagBtn.textContent = '‚è≥ Adding tags...';

        // Call bulk tag API
        const response = await apiRequest('/api/content/bulk/tag', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            ids: selectedIds,
            tags: tags,
            mode: 'add'
          }),
        });

        // Show result
        if (response.success) {
          showMessage(`Successfully added tags to ${response.results.successful.length} item(s)`, 'success');
        } else if (response.results.successful.length > 0) {
          showMessage(
            `Partially successful: ${response.results.successful.length} updated, ${response.results.failed.length} failed`,
            'warning'
          );
        } else {
          showMessage('Failed to add tags', 'error');
        }

        // Reload items
        await loadRecentItems();
      } catch (error) {
        console.error('Bulk tag operation failed:', error);
        alert(`Failed to add tags: ${error.message}`);

        // Restore button
        const tagBtn = document.getElementById('bulk-tag-btn');
        tagBtn.disabled = false;
        tagBtn.textContent = 'üè∑Ô∏è Add Tags';
      }
    }

    // Initialize
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadRecentItems();
      });
    } else {
      loadStats();
      loadRecentItems();
    }
  </script>
</body>
</html>
